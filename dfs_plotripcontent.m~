%% Neurofeedback Manu: generate plot of decode + rips
% 
% run on 1 rat at a time; plateau eps: remy: gus:26-30 (worst decoding) bernard:20-28, fievel:18-29 (nice decodes d19)
animals = {'fievel'}; %{'remy','gus','bernard','fievel'}; %

%epochfilter{1} = ['(isequal($cond_phase,''plateau'')) & $ripthresh>=0 & $gooddecode==1'];  % for conditioning rats

epochfilter{1} = ['$session==20 & isequal($type,''run'')'];

% resultant excludeperiods will define times when velocity is high
timefilter{1} = {'ag_get2dstate', '($immobility == 1)','immobility_velocity',4,'immobility_buffer',0};
iterator = 'epochbehaveanal';

% manually specify the tetrode to add
%tet = [25 26 30]; % remy
%tet = [12,18,25]; % bernard
tet = [16,24,27]; % fievel
%tet = [13 15 18]; %monty 2 7 12

f = createfilter('animal',animals,'epochs',epochfilter,'excludetime', timefilter, 'iterator', iterator);
f = setfilterfunction(f, 'dfa_plotripcontent_nf', {'ripdecodesv3','trials','marks','tetinfo'},'animal',animals{1},'posterior',1,'v',3,'tet',tet,'span','full');
f = runfilter(f);

%% 
pos = loaddatastruct('/mnt/cumulus/anna/despereaux/filterframework/','despereaux','pos',[8 2])
trials = loaddatastruct('/mnt/cumulus/anna/despereaux/filterframework/','despereaux','pos',[8 2])
ex = find(pos{8}{2}.data(:,1)>5215 & pos{8}{2}.data(:,1)<5265);
figure; hold on
plot(pos{8}{2}.data(:,6),pos{8}{2}.data(:,7),'Color',[.8 .8 .8]);
plot(pos{8}{2}.data(ex,6),pos{8}{2}.data(ex,7),'m'); axis square
title('desp8_2 example 5215-5265s')